<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ãƒ¢ã‚°ãƒ©å©ã 1åˆ†ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆAPIå¯¾å¿œãƒ»å®‰å…¨è¨­è¨ˆï¼‰</title>
  <style>
    :root { --cols:4; --rows:4; --hole:21vw; --gap:2.5vw; --radius:2vw; }
    html,body { margin:0; height:100%; background:#0e0e10; color:#fff; font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif; overflow:hidden; overscroll-behavior:none; touch-action:none; }
    .wrap { height:100dvh; width:100vw; display:flex; flex-direction:column; align-items:center; box-sizing:border-box; padding:8px 10px; gap:8px; }

    .header { width:100%; display:flex; gap:2vw; align-items:center; justify-content:space-between; }
    .stats { display:flex; gap:2vw; align-items:center; }
    .badge { background:#1b1b1f; border:1px solid #2a2a33; padding:.9vw 1.6vw; border-radius:999px; font-size:3.6vw; min-width:16vw; text-align:center; }

    .controls { display:flex; gap:2vw; align-items:center; }
    button { border:none; border-radius:3vw; padding:1.2vw 2.2vw; background:#2b2b33; color:#fff; font-weight:700; font-size:3.6vw; }
    button:active { transform:translateY(1px); }
    #startBtn { background:#2563eb; color:#fff; padding:1.4vw 3.2vw; min-width:28vw; }
    #lbBtn { background:#1b1b1f; border:1px solid #2a2a33; border-radius:999px; padding:.9vw 1.8vw; font-size:3.6vw; }

    .main { flex:1; display:flex; justify-content:center; align-items:center; }
    .board { width:calc(var(--cols)*var(--hole)+(var(--cols)-1)*var(--gap)); height:calc(var(--rows)*var(--hole)+(var(--rows)-1)*var(--gap)); display:grid; grid-template-columns:repeat(var(--cols),var(--hole)); grid-template-rows:repeat(var(--rows),var(--hole)); gap:var(--gap); }
    .hole { position:relative; background: radial-gradient(ellipse at center,#15151a 0%,#0f0f12 70%,#07070a 100%); border-radius:calc(var(--radius)+4px); overflow:hidden; }
    .target { position:absolute; inset:auto 0 0 0; margin:auto; width:88%; aspect-ratio:1/1; transform:translateY(110%); transition: transform .2s cubic-bezier(.2,.7,.2,1), filter .1s ease; border-radius:12px; pointer-events:auto; }
    .target.up { transform:translateY(0); }
    .target.hit { filter:brightness(.85) grayscale(.2); }
    .float { position:absolute; left:50%; top:30%; transform:translateX(-50%); font-weight:900; font-size:4.2vw; text-shadow:0 2px 6px rgba(0,0,0,.6); opacity:0; pointer-events:none; }

    .footer { width:100%; display:flex; justify-content:space-between; align-items:center; font-size:3.2vw; }

    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000; padding:12px; }
    .modal { background:#121219; border:1px solid #2a2a33; border-radius:16px; padding:18px; max-width:560px; width:94vw; }
    .celebrate { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1100; }

    @media (min-width: 721px) {
      :root { --hole:120px; --gap:12px; --radius:14px; }
      .badge, button, #lbBtn { font-size:14px; }
      #startBtn { min-width:140px; }
      .float { font-size:18px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <header class="header">
    <div class="stats">
      <div class="badge">Score <span id="score">0</span></div>
      <div class="badge">Time <span id="time">60</span>s</div>
      <button id="lbBtn" class="badge" style="cursor:pointer;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    </div>
    <div class="controls">
      <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </header>

  <main class="main">
    <div class="board" id="board"></div>
  </main>

  <footer class="footer">ã‚¯ãƒ©ã‚¦ãƒ³ã‚’å©ã‘ã°åŠ ç®—ã€ã‚»ãƒãƒã‚¤ãƒˆã‚’å©ãã¨æ¸›ç‚¹ã€‚ã‚³ãƒ³ãƒœã‚’ç¶šã‘ã¦å¤§é‡å¾—ç‚¹GETï¼</footer>
</div>

<!-- ã‚µã‚¦ãƒ³ãƒ‰ -->
<audio id="smashAudio" src="smash.mp3" preload="auto"></audio>
<audio id="noAudio" src="no.mp3" preload="auto"></audio>
<audio id="bgmAudio" src="BGM.mp3" preload="auto" loop></audio>
<audio id="congAudio" src="cong.mp3" preload="auto"></audio>

<!-- ã‚¹ã‚³ã‚¢ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="overlay" id="entryOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h2>ã‚¹ã‚³ã‚¢ç™»éŒ²</h2>
    <p>TOP15ã«å…¥ã£ãŸã§ï¼åå‰ã‚’å…¥ã‚Œã¦ç™»éŒ²ã—ã‚ˆã‹ï¼Ÿ</p>
    <div style="display:flex; gap:8px; margin-top:10px;">
      <input id="nameInput" type="text" maxlength="16" placeholder="åå‰ï¼ˆæœªå…¥åŠ›ãªã‚‰ã€åç„¡ã—ã•ã‚“ã€ï¼‰" style="flex:1; background:#1b1b22; border:1px solid #2b2b33; border-radius:10px; color:#fff; padding:10px 12px; font-size:16px;" />
      <button id="saveScore">ç™»éŒ²</button>
      <button id="skipScore">ã‚¹ã‚­ãƒƒãƒ—</button>
    </div>
  </div>
</div>

<!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="overlay" id="lbOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
      <span>TOP15 ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
      <button id="closeLB">é–‰ã˜ã‚‹</button>
    </h2>
    <div class="lb-wrap" style="overflow:auto; max-height:60dvh; border-radius:12px; margin-top:8px;">
      <table id="lbTable" style="width:100%; border-collapse:separate; border-spacing:0 8px;">
        <thead><tr><th>#</th><th>åå‰</th><th>ã‚¹ã‚³ã‚¢</th><th>æ—¥æ™‚</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ãŠç¥ã„ -->
<div class="celebrate" id="celebrate"><div class="msg" style="background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.15); backdrop-filter: blur(8px); padding:14px 18px; border-radius:16px; font-size:20px; font-weight:900; box-shadow:0 10px 40px rgba(0,0,0,.5);">ğŸ‰ ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ï¼ãŠã‚ã§ã¨ã†ï¼</div></div>

<script>
(function(){
  // ===== ç«¯æœ«ã®ã‚¹ãƒ¯ã‚¤ãƒ—/ã‚ºãƒ¼ãƒ ã‚’æŠ‘æ­¢ =====
  const stop = (e)=>{ e.preventDefault(); };
  document.addEventListener('touchmove', stop, {passive:false});
  document.addEventListener('gesturestart', stop);
  window.addEventListener('scroll', ()=> window.scrollTo(0,0));

  // ===== å®šæ•° =====
  const COLS=4, ROWS=4;
  const API_BASE = "https://junkhin.com/api";   // æ—¢å­˜APIã‚’ä½¿ç”¨ï¼ˆscoresã¯å¤‰æ›´ã—ãªã„ï¼‰
  const GAME_ID  = "whack";                      // ã“ã®ã‚²ãƒ¼ãƒ ã®è­˜åˆ¥å­

  const boardEl=document.getElementById('board');
  const scoreEl=document.getElementById('score');
  const timeEl=document.getElementById('time');
  const startBtn=document.getElementById('startBtn');
  const lbBtn=document.getElementById('lbBtn');
  const lbTableBody=document.querySelector('#lbTable tbody');
  const lbOverlay=document.getElementById('lbOverlay');
  const closeLB=document.getElementById('closeLB');
  const entryOverlay=document.getElementById('entryOverlay');
  const nameInput=document.getElementById('nameInput');
  const saveScoreBtn=document.getElementById('saveScore');
  const skipScoreBtn=document.getElementById('skipScore');
  const celebrate=document.getElementById('celebrate');

  const smashAudio=document.getElementById('smashAudio');
  const noAudio=document.getElementById('noAudio');
  const bgmAudio=document.getElementById('bgmAudio');
  const congAudio=document.getElementById('congAudio');

  const KEY_NAME='whack_name';
  const IMG_CC='CC.png';
  const IMG_NN='NN.png';

  let score=0, combo=0, timeLeft=60;
  let timerId=null, spawnTimeout=null; // setTimeout å†å¸°ã§å®‰å®šã‚¹ãƒãƒ¼ãƒ³
  let running=false, paused=false;

  // ãƒ†ãƒ³ãƒï¼šå°‘ã—é…ã‚ã‚¹ã‚¿ãƒ¼ãƒˆâ†’ã˜ã‚ã£ã¨åŠ é€Ÿ
  let speed=1050, interval=900; // è¡¨ç¤ºæ™‚é–“ms / å‡ºç¾é–“éš”ms
  const minSpeed=600, minInterval=520; // åŠ é€Ÿã®ä¸‹é™

  // ===== API =====
  async function fetchLB(){
    const url = `${API_BASE}/getscores.php?game=${encodeURIComponent(GAME_ID)}&limit=15`;
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok){ const txt = await res.text(); throw new Error(`getscores ${res.status}: ${txt.slice(0,200)}`); }
    const data = await res.json();
    return (Array.isArray(data)?data:[]).map(r=>({ name:r.name??'åç„¡ã—ã•ã‚“', score:Number(r.score)||0, ts:r.ts??'' }));
  }
  async function submitScore(name,score){
    const url = `${API_BASE}/postscores.php`;
    const body = new URLSearchParams({ game: GAME_ID, name, score: String(score) });
    const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body });
    if(!res.ok){ const txt = await res.text(); throw new Error(`postscores ${res.status}: ${txt.slice(0,200)}`); }
    return await res.json();
  }

  // ===== ç›¤é¢ =====
  function buildBoard(){
    boardEl.innerHTML='';
    for(let i=0;i<COLS*ROWS;i++){
      const hole=document.createElement('div'); hole.className='hole';
      const img=document.createElement('img'); img.className='target'; img.alt='target'; img.draggable=false; img.decoding='async';
      img.addEventListener('pointerdown', onHit, {passive:true});
      hole.appendChild(img);
      const fl=document.createElement('div'); fl.className='float'; hole.appendChild(fl);
      boardEl.appendChild(hole);
    }
  }

  function setScore(v){ score=v; scoreEl.textContent=v; }
  function setCombo(v){ combo=v; }

  function updateStartButton(){ if(!running){ startBtn.textContent='ã‚¹ã‚¿ãƒ¼ãƒˆ'; return; } startBtn.textContent = paused ? 'å†é–‹' : 'ä¸€æ™‚åœæ­¢'; }

  function startGame(){
    running=true; paused=false; setScore(0); setCombo(0); timeLeft=60; timeEl.textContent=timeLeft;
    [smashAudio,noAudio,bgmAudio,congAudio].forEach(a=>{ try{ a.load(); }catch(e){} });
    try{ bgmAudio.currentTime=0; bgmAudio.play().catch(()=>{}); }catch(e){}
    runTimer(); scheduleNextSpawn(interval); updateStartButton();
  }

  function toggleStartPause(){ if(!running){ startGame(); } else if(!paused){ pauseGame(); } else { resumeGame(); } }

  function pauseGame(){ if(!running||paused) return; paused=true; updateStartButton(); clearInterval(timerId); clearTimeout(spawnTimeout); try{ bgmAudio.pause(); }catch(e){}; document.querySelectorAll('.target').forEach(img=>{ if(img._hideTid){ clearTimeout(img._hideTid); img._hideTid=null; } }); }
  function resumeGame(){ if(!running||!paused) return; paused=false; updateStartButton(); try{ bgmAudio.play().catch(()=>{}); }catch(e){}; runTimer(); scheduleNextSpawn(0); document.querySelectorAll('.target.up').forEach(img=>{ if(!img._hideTid){ img._hideTid=setTimeout(()=>{ instantHide(img); }, 600); } }); }

  function runTimer(){ clearInterval(timerId); timerId=setInterval(()=>{ timeLeft--; timeEl.textContent=timeLeft; if(timeLeft<=0){ clearInterval(timerId); timeLeft=0; timeEl.textContent=0; endGame(); } },1000); }

  function scheduleNextSpawn(delay){ clearTimeout(spawnTimeout); spawnTimeout = setTimeout(spawnTick, delay); }
  function spawnTick(){
    if(!running || paused){ scheduleNextSpawn(200); return; }
    const holes=[...document.querySelectorAll('.hole')];
    const count=Math.random()<0.18?2:1;
    for(let k=0;k<count;k++){
      const hole=holes[Math.floor(Math.random()*holes.length)];
      const img=hole.querySelector('.target'); if(img.classList.contains('up')) continue;
      const isNN=Math.random()<0.2; img.src=isNN?IMG_NN:IMG_CC; img.dataset.kind=isNN?'nn':'cc';
      img.classList.add('up'); img.classList.remove('hit'); img.style.pointerEvents='auto';
      const showFor=Math.max(minSpeed, speed + (Math.random()*220-110));
      img._hideTid=setTimeout(()=>{ instantHide(img); }, showFor);
    }
    if(interval>minInterval) interval-=5; if(speed>minSpeed) speed-=4;
    scheduleNextSpawn(interval);
  }

  function instantHide(img){ img.classList.remove('up'); img.style.pointerEvents='none'; const prev=img.style.transition; img.style.transition='none'; img.style.transform='translateY(110%)'; img.offsetHeight; img.style.transition=prev; img._hideTid=null; }

  function onHit(e){
    if(!running || paused) return;
    const img=e.currentTarget; if(!img.classList.contains('up')||img.classList.contains('hit')) return;
    img.classList.add('hit'); if(img._hideTid){ clearTimeout(img._hideTid); img._hideTid=null; }
    instantHide(img);
    const hole=img.parentElement; const fl=hole.querySelector('.float');
    if(img.dataset.kind==='cc'){ setCombo(combo+1); setScore(score+combo); playAudio(smashAudio); floatText(fl, `+${combo}`); }
    else { setCombo(0); setScore(score-50); playAudio(noAudio); floatText(fl, `-50`); }
  }

  function playAudio(a){ try{ a.currentTime=0; a.play().catch(()=>{}); }catch(e){} }
  function floatText(el, text){ el.textContent=text; el.style.transition='none'; el.style.opacity='0'; el.style.transform='translate(-50%, 8px) scale(0.96)'; requestAnimationFrame(()=>{ el.style.transition='transform .18s ease, opacity .18s ease'; el.style.opacity='1'; el.style.transform='translate(-50%, -16px) scale(1)'; setTimeout(()=>{ el.style.opacity='0'; }, 180); }); }

  async function endGame(){
    running=false; paused=false; updateStartButton(); clearTimeout(spawnTimeout); try{ bgmAudio.pause(); }catch(e){}
    document.querySelectorAll('.target').forEach(t=>{ instantHide(t); });
    try{
      const lb = await fetchLB();
      const qualifies = lb.length < 15 || score > (lb[lb.length-1]?.score ?? -Infinity);
      if(score !== 0 && qualifies){ nameInput.value = localStorage.getItem(KEY_NAME)||''; entryOverlay.style.display='flex'; }
    }catch(err){ console.warn('LB fetch failed', err); }
  }

  // ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆAPIï¼‰ =====
  async function renderLB(){
    lbTableBody.innerHTML = '<tr><td colspan="4" style="opacity:.7; padding:12px;">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>';
    try{
      const lb = await fetchLB();
      lbTableBody.innerHTML = '';
      lb.forEach((r,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td style="width:56px; text-align:center; font-weight:800;">${idx+1}</td>
          <td style="max-width:38vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${esc(r.name)}</td>
          <td style="text-align:right; font-weight:900;">${Number(r.score).toLocaleString()}</td>
          <td style="opacity:.7; font-size:12px;">${fmtDate(r.ts)}</td>`;
        lbTableBody.appendChild(tr);
      });
    }catch(err){
      lbTableBody.innerHTML = `<tr><td colspan="4" style="color:#f77; padding:12px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ<br><small>${esc(String(err.message||err)).slice(0,160)}</small></td></tr>`;
    }
  }

  async function finalizeEntry(){
    const name = nameInput.value.trim() || 'åç„¡ã—ã•ã‚“';
    localStorage.setItem(KEY_NAME, name);
    entryOverlay.style.display='none';
    try{ await submitScore(name, score); }
    catch(e){ alert('ã‚¹ã‚³ã‚¢é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ
'+(e.message||e)); }
    await renderLB();
    celebrateRank();
  }

  function celebrateRank(){ try{ congAudio.currentTime=0; congAudio.play().catch(()=>{}); }catch(e){} celebrate.style.display='flex'; spawnConfetti(); setTimeout(()=>{ celebrate.style.display='none'; celebrate.innerHTML='<div class="msg" style="background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.15); backdrop-filter: blur(8px); padding:14px 18px; border-radius:16px; font-size:20px; font-weight:900; box-shadow:0 10px 40px rgba(0,0,0,.5);">ğŸ‰ ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ï¼ãŠã‚ã§ã¨ã†ï¼</div>'; }, 2200); }
  function spawnConfetti(){ const colors=['#ff5f6d','#f9cb28','#36d1dc','#5b86e5','#a8ff78','#78ffd6','#c471f5','#fa71cd','#f6d365','#fda085','#f093fb','#f5576c']; const N=60; for(let i=0;i<N;i++){ const d=document.createElement('div'); d.className='confetti'; d.style.position='absolute'; d.style.top='-10vh'; d.style.left=Math.random()*100+'vw'; d.style.width='8px'; d.style.height='14px'; d.style.borderRadius='2px'; d.style.opacity='.95'; d.style.background=colors[Math.floor(Math.random()*colors.length)]; d.style.animation='fall 1.6s linear forwards'; d.style.transform=`translateY(0) rotate(${Math.random()*360}deg)`; celebrate.appendChild(d);} setTimeout(()=>{ document.querySelectorAll('.confetti').forEach(x=>x.remove()); },2400); }

  // ===== Util =====
  function fmtDate(v){ if(!v) return ''; const d=new Date((v+'').replace(' ','T')); if(isNaN(d)) return v; return `${d.getFullYear()}/${(d.getMonth()+1+'').padStart(2,'0')}/${(d.getDate()+'').padStart(2,'0')} ${(d.getHours()+'').padStart(2,'0')}:${(d.getMinutes()+'').padStart(2,'0')}`; }
  function esc(s){ return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",
                                 ">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆ =====
  saveScoreBtn.addEventListener('click', finalizeEntry);
  skipScoreBtn.addEventListener('click', async ()=>{ entryOverlay.style.display='none'; await renderLB(); lbOverlay.style.display='flex'; });
  lbBtn.addEventListener('click', async ()=>{ await renderLB(); lbOverlay.style.display='flex'; });
  closeLB.addEventListener('click', ()=> lbOverlay.style.display='none');
  startBtn.addEventListener('click', toggleStartPause);

  // ===== åˆæœŸåŒ– =====
  buildBoard(); updateStartButton();
})();
</script>
</body>
</html>

<!-- ============================
/API/ å´ã® PHP ï¼ˆå‰ä½œã¨åŒåã§OKã€‚æ—¢å­˜ scores ã‚’å£Šã•ãªã„å®‰å…¨ç‰ˆï¼‰
ãƒã‚¤ãƒ³ãƒˆï¼š
- æ—¢å­˜ã® scores ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä¸€åˆ‡å¤‰æ›´ã—ãªã„
- scores ã« game åˆ—ãŒã€Œã‚ã‚‹å ´åˆã€â€¦ game ã§çµã‚‹
- scores ã« game åˆ—ãŒã€Œãªã„å ´åˆã€â€¦ whack ã¯ scores_whackï¼ˆæ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã‚’ä½¿ç”¨
- CORS ãƒ˜ãƒƒãƒ€ä»˜ä¸ã€ä¾‹å¤–æ™‚ã¯JSONã§ç†ç”±ã‚’è¿”ã™
============================= -->

<!-- File: /API/getscores.php -->
<?php
header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');

$game  = isset($_GET['game']) ? substr($_GET['game'], 0, 32) : 'match3';
$limit = isset($_GET['limit']) ? (int)$_GET['limit'] : 15;
if ($limit < 1 || $limit > 100) $limit = 15;

try {
  // â† ã“ã“ã¯ã”ç’°å¢ƒã«åˆã‚ã›ã¦è¨­å®š
  $pdo = new PDO('mysql:host=mysql324.phy.lolipop.lan;dbname=LA03519144-upos;charset=utf8mb4', 'DB_USER', 'DB_PASS', [ PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION ]);

  // scores ã« game åˆ—ãŒã‚ã‚‹ã‹ï¼Ÿ
  $hasGameCol = false;
  try { $stmt=$pdo->query("SHOW COLUMNS FROM `scores` LIKE 'game'"); $hasGameCol = (bool)$stmt->fetch(); } catch (Throwable $e) { $hasGameCol=false; }

  // whack ç”¨ã®ä»£æ›¿ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ—¢å­˜ scores ã‚’è§¦ã‚‰ãªã„ï¼‰
  if (!$hasGameCol && $game === 'whack') {
    // å¿…è¦ãªã‚‰ä½œæˆï¼ˆãªã‘ã‚Œã°ä½œã‚‹ï¼‰
    $pdo->exec("CREATE TABLE IF NOT EXISTS `scores_whack` (
      `id` INT AUTO_INCREMENT PRIMARY KEY,
      `name` VARCHAR(32) NOT NULL,
      `score` INT NOT NULL,
      `ts` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      INDEX (`score`), INDEX (`ts`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

    $sql = "SELECT name, score, ts FROM `scores_whack` ORDER BY score DESC, ts ASC LIMIT :lim";
    $stmt = $pdo->prepare($sql);
    $stmt->bindValue(':lim', $limit, PDO::PARAM_INT);
    $stmt->execute();
    echo json_encode($stmt->fetchAll(PDO::FETCH_ASSOC), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES);
    exit;
  }

  // é€šå¸¸ï¼šscores ã‚’ä½¿ç”¨ï¼ˆgameåˆ—ãŒã‚ã‚Œã°çµã‚Šè¾¼ã‚€ï¼ãªã‘ã‚Œã°å…¨ä½“ï¼‰
  if ($hasGameCol) {
    $sql = "SELECT name, score, ts FROM `scores` WHERE game = :g ORDER BY score DESC, ts ASC LIMIT :lim";
    $stmt = $pdo->prepare($sql);
    $stmt->bindValue(':g', $game, PDO::PARAM_STR);
  } else {
    $sql = "SELECT name, score, ts FROM `scores` ORDER BY score DESC, ts ASC LIMIT :lim";
    $stmt = $pdo->prepare($sql);
  }
  $stmt->bindValue(':lim', $limit, PDO::PARAM_INT);
  $stmt->execute();
  echo json_encode($stmt->fetchAll(PDO::FETCH_ASSOC), JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES);
} catch (Throwable $e) {
  http_response_code(500);
  echo json_encode(['ok'=>false,'err'=>'server','msg'=>$e->getMessage()]);
}
?>

<!-- File: /API/postscores.php -->
<?php
header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { exit; }
if ($_SERVER['REQUEST_METHOD'] !== 'POST') { http_response_code(405); echo json_encode(['ok'=>false,'err'=>'method']); exit; }

$game  = substr($_POST['game']  ?? 'match3', 0, 32);
$name  = trim($_POST['name'] ?? '');
$score = (int)($_POST['score'] ?? 0);
if ($name === '') $name = 'åç„¡ã—ã•ã‚“';
if (mb_strlen($name) > 16) $name = mb_substr($name, 0, 16);

try {
  // â† ã“ã“ã¯ã”ç’°å¢ƒã«åˆã‚ã›ã¦è¨­å®š
  $pdo = new PDO('mysql:host=mysql324.phy.lolipop.lan;dbname=LA03519144-upos;charset=utf8mb4', 'DB_USER', 'DB_PASS', [ PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION ]);

  // scores ã« game åˆ—ãŒã‚ã‚‹ã‹ï¼Ÿ
  $hasGameCol = false;
  try { $stmt=$pdo->query("SHOW COLUMNS FROM `scores` LIKE 'game'"); $hasGameCol = (bool)$stmt->fetch(); } catch (Throwable $e) { $hasGameCol=false; }

  if (!$hasGameCol && $game === 'whack') {
    // æ—¢å­˜ scores ã¯è§¦ã‚‰ãš whack å°‚ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
    $pdo->exec("CREATE TABLE IF NOT EXISTS `scores_whack` (
      `id` INT AUTO_INCREMENT PRIMARY KEY,
      `name` VARCHAR(32) NOT NULL,
      `score` INT NOT NULL,
      `ts` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      INDEX (`score`), INDEX (`ts`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4");

    $stmt = $pdo->prepare("INSERT INTO `scores_whack` (name, score) VALUES(:n,:s)");
    $stmt->bindValue(':n', $name,  PDO::PARAM_STR);
    $stmt->bindValue(':s', $score, PDO::PARAM_INT);
    $stmt->execute();
    echo json_encode(['ok'=>true]);
    exit;
  }

  // é€šå¸¸ï¼šscores ã‚’ä½¿ç”¨ï¼ˆgameåˆ—ãŒã‚ã‚Œã°åˆ†é›¢ã€ãªã‘ã‚Œã°å¾“æ¥ã©ãŠã‚Šï¼‰
  if ($hasGameCol) {
    $stmt = $pdo->prepare("INSERT INTO `scores` (game, name, score) VALUES(:g,:n,:s)");
    $stmt->bindValue(':g', $game,  PDO::PARAM_STR);
  } else {
    $stmt = $pdo->prepare("INSERT INTO `scores` (name, score) VALUES(:n,:s)");
  }
  $stmt->bindValue(':n', $name,  PDO::PARAM_STR);
  $stmt->bindValue(':s', $score, PDO::PARAM_INT);
  $stmt->execute();

  echo json_encode(['ok'=>true]);
} catch (Throwable $e) {
  http_response_code(500);
  echo json_encode(['ok'=>false,'err'=>'server','msg'=>$e->getMessage()]);
}
?>

<!-- ============================
MySQL ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ–¹æ³•ï¼ˆphpMyAdmin / ã‚³ãƒãƒ³ãƒ‰ï¼‰
â€» å®Ÿè¡Œç”¨ãƒ¡ãƒ¢ã€‚ã‚³ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
============================= -->
<!--
[phpMyAdmin ã§ãƒ†ãƒ¼ãƒ–ãƒ« scores ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—]
1) phpMyAdmin ãƒ­ã‚°ã‚¤ãƒ³ â†’ å·¦ã®DBâ†’ãƒ†ãƒ¼ãƒ–ãƒ« scores ã‚’é¸æŠ
2) ä¸Šéƒ¨ã€Œã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€â†’ æ–¹æ³•: ã‚¯ã‚¤ãƒƒã‚¯ / å½¢å¼: SQL â†’ ã€Œå®Ÿè¡Œã€
   â†’ scores_backup_YYYYMMDD.sql ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™

[phpMyAdmin ã§DBå…¨ä½“ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—]
1) å·¦ã®DBåï¼ˆãƒ«ãƒ¼ãƒˆã§ã¯ãªãã€ä»Šå›ã®DBï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯
2) ã€Œã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€â†’ ã‚¯ã‚¤ãƒƒã‚¯ / SQL â†’ å®Ÿè¡Œ

[SSH/ã‚³ãƒãƒ³ãƒ‰ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—]
$ mysqldump -u <USER> -p <DBå> scores > scores_backup.sql
# DBå…¨ä½“
$ mysqldump -u <USER> -p <DBå> > db_backup.sql

â†’ ä½•ã‹ã‚ã‚Œã°ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ phpMyAdmin ã®ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã‹ã‚‰æˆ»ã›ã¾ã™
-->
