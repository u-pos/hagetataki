<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ãƒã‚²ãŸãŸã</title>
  <style>
    :root {
      --cols:4; --rows:4;
      --hole:21vw;         /* 1ãƒã‚¹ã®ã‚µã‚¤ã‚º */
      --gap:2.2vw;         /* ãƒã‚¹é–“ã®éš™é–“ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ï¼‰ */
      --radius:2vw;

      /* â˜… æ ç·šã®å¤ªã•ï¼ˆè¡¨ç¤ºã®ã¿ï¼‰ã€‚gapã«ã¯å½±éŸ¿ã—ãªã„ */
      --glow: clamp(2px, 1.0vw, 6px);
      --ring: clamp(1px, 0.7vw, 4px);
      --glowOffset: calc((var(--gap) - var(--glow)) / 2);
    }

    html,body { margin:0; height:100%; background:#0e0e10; color:#fff; font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif; overflow:hidden; overscroll-behavior:none; touch-action:none; }
    .wrap { height:100dvh; width:100vw; display:flex; flex-direction:column; align-items:center; box-sizing:border-box; padding:6px 8px; gap:6px; position:relative; }

    .header { width:100%; display:flex; gap:2vw; align-items:center; justify-content:space-between; }
    .stats { display:flex; gap:2vw; align-items:center; }
    .badge { background:#1b1b1f; border:1px solid #2a2a33; padding:1.2vw 2.2vw; border-radius:999px; font-size:5.4vw; min-width:18vw; text-align:center; line-height:1; }
    .badge span { display:inline-block; min-width:10vw; }

    .controls { display:flex; gap:2vw; align-items:center; }
    button { border:none; border-radius:5vw; padding:1.6vw 4.8vw; background:#2563eb; color:#fff; font-weight:800; font-size:5.0vw; }
    button:active { transform:translateY(1px); }

    .main { flex:1; display:flex; justify-content:center; align-items:center; }

    /* ç›¤é¢ãƒ©ãƒƒãƒ‘ï¼ˆå¤–æ ãƒªãƒ³ã‚°ç”¨ï¼‰ */
    .boardWrap { position:relative; display:inline-block; border-radius:10px; }
    /* è™¹è‰²å¤–æ ï¼ˆãƒªãƒ³ã‚°ï¼‰ */
    .boardWrap.fever::after{
      content:""; position:absolute; inset:0; border-radius:10px; pointer-events:none;
      padding: var(--ring);
      background: linear-gradient(130deg,#f00,#ff9a00,#d0de21,#4fdc4a,#3fdad8,#2fc9e2,#1c7fee,#5f15f2,#ba0cf8,#fb07d9,#f00);
      background-size:200% 200%;
      animation: rainbowShift .35s linear infinite, feverBlink .06s steps(2,end) infinite;
      /* ä¸­æŠœãã§â€œæ ã ã‘â€ã«ã™ã‚‹ãƒã‚¹ã‚¯ */
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
              mask-composite: exclude;
      z-index:10;
    }

    /* ç›¤é¢ */
    .board {
      width:calc(var(--cols)*var(--hole)+(var(--cols)-1)*var(--gap));
      height:calc(var(--rows)*var(--hole)+(var(--rows)-1)*var(--gap));
      display:grid;
      grid-template-columns:repeat(var(--cols),var(--hole));
      grid-template-rows:repeat(var(--rows),var(--hole));
      gap:var(--gap);
      border-radius:10px;
      box-sizing:border-box;
      position:relative; /* å†…å´ã‚°ãƒªãƒƒãƒ‰ã®åŸºæº– */
      background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
    }

    .hole { position:relative; background: radial-gradient(ellipse at center,#15151a 0%,#0f0f12 70%,#07070a 100%); border-radius:calc(var(--radius)+4px); overflow:hidden; }
    .target { position:absolute; inset:auto 0 0 0; margin:auto; width:88%; aspect-ratio:1/1; transform:translateY(110%); transition: transform .2s cubic-bezier(.2,.7,.2,1), filter .1s ease; border-radius:12px; pointer-events:auto; }
    .target.up { transform:translateY(0); }
    .target.hit { filter:brightness(.85) grayscale(.2); }
    .float { position:absolute; left:50%; top:30%; transform:translateX(-50%); font-weight:900; font-size:4.6vw; text-shadow:0 2px 6px rgba(0,0,0,.6); opacity:0; pointer-events:none; }

    .footer { width:100%; display:flex; justify-content:center; align-items:center; font-size:3.6vw; text-align:center; padding-bottom:2px; }

    /* çµæœç™ºè¡¨ï¼ˆå…¨ç”»é¢ï¼‰ */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1200; padding:12px; }
    .resultBox { background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.15); backdrop-filter: blur(6px); border-radius:18px; padding:22px 24px; text-align:center; }
    .resultScore { font-size:12vw; font-weight:900; line-height:1.1; }
    .resultBtns { margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .resultBtns button { font-size:5vw; padding:1.2vw 4vw; border-radius:4vw; background:#2563eb; color:#fff; border:none; font-weight:800; }

    /* ä¸€æ™‚åœæ­¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆç”»é¢å…¨ä½“ã‚’è¦†ã†ï¼‰ */
    .pause-overlay{ position: fixed; inset: 0; width:100vw; height:100dvh; display: none; align-items: center; justify-content: center; background: black; z-index: 1300; flex-direction: column; color: white; border-radius: 0; gap: 16px; padding: 16px; }
    #pauseText{ font-weight:900; font-size:clamp(22px,8vw,56px); letter-spacing:.02em; text-shadow:0 2px 10px rgba(0,0,0,.35); }
    .pause-overlay .start-btn{ font-size:clamp(18px,6vw,28px); padding:12px 28px; border-radius:999px; }

    /* ä¸‹éƒ¨ã‚¢ã‚¤ã‚³ãƒ³åˆ— */
    .bottom-buttons {display:flex;justify-content:center;align-items:center;gap:1.5rem;margin-top:0.4rem;}
    .icon-btn {background:none;border:none;font-size:2.8rem;color:white;cursor:pointer;}

    /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆlocalStorageï¼TOP5ãƒ»æ—¥ä»˜ï¼†ç‚¹æ•°ã®ã¿ï¼‰ */
    #rankingOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1400; display: none; justify-content: center; align-items: center; padding: 12px; }
    .ranking-content { background: rgba(20,20,24,0.95); color: #fff; padding: 14px; border-radius: 12px; width: 92vw; max-width: 580px; display: flex; flex-direction: column; max-height: 80vh; overflow-y: auto; }
    .ranking-content h2 { text-align:center; margin: 4px 0 8px; }
    .lb-list { list-style: none; padding: 0; margin: 0; }
    .lb-list li { display:flex; gap:8px; align-items:center; justify-content:space-between; background: rgba(255,255,255,0.06); margin:6px 0; padding:8px 10px; border-radius:10px; }
    .lb-rank { width:2.4em; text-align:center; font-weight:900; }
    .lb-name { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; } /* æ—¥ä»˜è¡¨ç¤ºç”¨ */
    .lb-score { min-width:6.5em; text-align:right; font-weight:900; display:flex; gap:6px; align-items:center; justify-content:flex-end; }
    .lb-new { color:#ffde59; font-weight:900; }

    /* ===== ç›¤é¢ã®å…¨â€œç·šâ€ã‚’è™¹è‰²é«˜é€Ÿç‚¹æ»…ï¼ˆå†…å´ã‚°ãƒªãƒƒãƒ‰ï¼‰ ===== */
    @keyframes rainbowShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    @keyframes feverBlink  { 0%{opacity:.25} 100%{opacity:1} }

    /* ç¸¦ã®ä»•åˆ‡ã‚Šç·šï¼šå„gapä¸­å¤®ã«ç´°ã„å¸¯ã ã‘è¡¨ç¤º */
    .board.fever::before{
      content:"";
      position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      background: linear-gradient(130deg,#f00,#ff9a00,#d0de21,#4fdc4a,#3fdad8,#2fc9e2,#1c7fee,#5f15f2,#ba0cf8,#fb07d9,#f00);
      background-size:200% 200%;
      -webkit-mask: repeating-linear-gradient(to right,
        /* 0..hole+offset ã¯é€æ˜ */
        transparent 0 calc(var(--hole) + var(--glowOffset)),
        /* ä¸­å¤®ã®ç´°ç·šã ã‘å¯è¦–ï¼ˆ--glowå¹…ï¼‰ */
        #000       calc(var(--hole) + var(--glowOffset)) calc(var(--hole) + var(--glowOffset) + var(--glow)),
        /* æ®‹ã‚Šã¯é€æ˜ .. å‘¨æœŸçµ‚ç«¯ */
        transparent calc(var(--hole) + var(--glowOffset) + var(--glow)) calc(var(--hole) + var(--gap))
      );
              mask: repeating-linear-gradient(to right,
        transparent 0 calc(var(--hole) + var(--glowOffset)),
        #000       calc(var(--hole) + var(--glowOffset)) calc(var(--hole) + var(--glowOffset) + var(--glow)),
        transparent calc(var(--hole) + var(--glowOffset) + var(--glow)) calc(var(--hole) + var(--gap))
      );
      animation: rainbowShift .35s linear infinite, feverBlink .06s steps(2,end) infinite;
      z-index:5;
    }

    /* æ¨ªã®ä»•åˆ‡ã‚Šç·šï¼šå„gapä¸­å¤®ã«ç´°ã„å¸¯ã ã‘è¡¨ç¤º */
    .board.fever::after{
      content:"";
      position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      background: linear-gradient(130deg,#f00,#ff9a00,#d0de21,#4fdc4a,#3fdad8,#2fc9e2,#1c7fee,#5f15f2,#ba0cf8,#fb07d9,#f00);
      background-size:200% 200%;
      -webkit-mask: repeating-linear-gradient(to bottom,
        transparent 0 calc(var(--hole) + var(--glowOffset)),
        #000       calc(var(--hole) + var(--glowOffset)) calc(var(--hole) + var(--glowOffset) + var(--glow)),
        transparent calc(var(--hole) + var(--glowOffset) + var(--glow)) calc(var(--hole) + var(--gap))
      );
              mask: repeating-linear-gradient(to bottom,
        transparent 0 calc(var(--hole) + var(--glowOffset)),
        #000       calc(var(--hole) + var(--glowOffset)) calc(var(--hole) + var(--glowOffset) + var(--glow)),
        transparent calc(var(--hole) + var(--glowOffset) + var(--glow)) calc(var(--hole) + var(--gap))
      );
      animation: rainbowShift .35s linear infinite, feverBlink .06s steps(2,end) infinite;
      z-index:5;
    }

    @media (min-width: 721px) {
      :root { --hole:120px; --gap:12px; --radius:14px; --glow: 4px; --ring: 2px; --glowOffset: calc((var(--gap) - var(--glow)) / 2); }
      .badge { font-size:22px; padding:8px 14px; }
      .controls button { font-size:22px; padding:10px 22px; border-radius:24px; }
      .float { font-size:18px; }
      .footer { font-size:15px; text-aligh:left; }
      .resultScore { font-size:72px; }
      .resultBtns button { font-size:20px; padding:8px 18px; border-radius:14px; }
    }

    /* === iOSãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§å¯¾ç­–: CSSå´ === */
    * { -webkit-tap-highlight-color: transparent; }
    img, .target, button { -webkit-user-select: none; user-select: none; -webkit-user-drag: none; -webkit-touch-callout: none; }
    #board, .hole, .target { touch-action: none; }
  </style>
</head>
<body>
<div class="wrap">
  <header class="header">
    <div class="stats">
      <div class="badge">Score <span id="score">0</span></div>
      <div class="badge">Time <span id="time">60</span>s</div>
    </div>
    <div class="controls">
      <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </header>

  <main class="main">
    <!-- â˜… å¤–æ ãƒªãƒ³ã‚°ç”¨ã®ãƒ©ãƒƒãƒ‘ã‚’è¿½åŠ  -->
    <div class="boardWrap" id="boardWrap">
      <div class="board" id="board"></div>
    </div>
  </main>

  <span style="color:yellow;">ã€ãƒ«ãƒ¼ãƒ«èª¬æ˜ã€‘</span>
  <footer class="footer">â—†ã‚¯ãƒ©ã‚¦ãƒ³ã‚’é€£ç¶šã§å©ã‘ã°åŠ ç‚¹ï¼ˆæœ€å¤§10ç‚¹)<br />â—†ã‚»ãƒãƒã‚¤ãƒˆã‚’å©ãã¨-10ç‚¹ã‹ã¤ã‚³ãƒ³ãƒœçµ‚äº†<br />â—†10ã‚³ãƒ³ãƒœã‚’ã‚­ãƒ¼ãƒ—ã—ã¦é«˜å¾—ç‚¹ã‚’ç‹™ãŠã†ï¼ï¼</footer>

  <!-- ä¸‹éƒ¨ã‚¢ã‚¤ã‚³ãƒ³ -->
  <div class="bottom-buttons">
    <button id="muteBtn" class="icon-btn" title="ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡æ›¿">ğŸ”‡</button>
    <button id="pauseBtn" class="icon-btn" title="ä¸€æ™‚åœæ­¢">â¸</button>
    <button id="rankingBtn" class="icon-btn" title="ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°">ğŸ†</button>
  </div>
</div>

<!-- ã‚µã‚¦ãƒ³ãƒ‰ -->
<audio id="smashAudio" src="smash.mp3" preload="auto"></audio>
<audio id="noAudio" src="no.mp3" preload="auto"></audio>
<audio id="bgmAudio" src="BGM.mp3" preload="auto" loop></audio>
<audio id="congAudio" src="cong.mp3" preload="auto"></audio>
<audio id="muchiAudio" src="muchi.mp3" preload="auto"></audio>
<audio id="feverAudio" src="fever.mp3" preload="auto"></audio>

<!-- ä¸€æ™‚åœæ­¢ -->
<div id="pauseOverlay" class="pause-overlay">
  <div id="pauseText">ä¸€æ™‚åœæ­¢ä¸­</div>
  <button id="resumeBtn" class="start-btn">â–¶ å†é–‹</button>
</div>

<!-- çµæœç™ºè¡¨ -->
<div class="overlay" id="resultOverlay" role="dialog" aria-modal="true">
  <div class="resultBox" id="resultBox">
    <div class="resultScore" id="resultText">ã‚¹ã‚³ã‚¢ 0ç‚¹</div>
    <div class="resultBtns" id="resultBtns"><button id="restartBtn">ã‚‚ã†ä¸€åº¦</button></div>
  </div>
</div>

<!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆlocalStorageï¼TOP5ï¼šæ—¥ä»˜ï¼‹ç‚¹æ•°ã®ã¿ï¼‰ -->
<div id="rankingOverlay">
  <div class="ranking-content">
    <div style="display:flex; justify-content:flex-end;">
      <button id="closeRanking" class="icon-btn" style="font-size:2rem;">âœ–</button>
    </div>
    <h2>ğŸ† ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP5</h2>
    <ol id="rankingList" class="lb-list"></ol>
    <div id="lbEmpty" style="opacity:.7; text-align:center; padding:8px; display:none;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
    <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
      <button id="lbRestart" class="start-btn" style="background:linear-gradient(90deg,#7b61ff,#3cd3ad);">RESTART</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* === iOSãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§å¯¾ç­–: JSå´ === */
  let __lastTouchEnd = 0;
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - __lastTouchEnd <= 350) e.preventDefault();
    __lastTouchEnd = now;
  }, { passive: false });
  document.addEventListener('dblclick', (e) => e.preventDefault(), { passive:false });

  // ===== ã‚¹ãƒ¯ã‚¤ãƒ—/ã‚ºãƒ¼ãƒ æŠ‘æ­¢ï¼ˆæ—¢å­˜ï¼‰ =====
  const stop = (e)=>{ e.preventDefault(); };
  document.addEventListener('touchmove', stop, {passive:false});
  document.addEventListener('gesturestart', stop);
  window.addEventListener('scroll', ()=> window.scrollTo(0,0));

  // ===== å®šæ•°ãƒ»è¦ç´  =====
  const COLS=4, ROWS=4;
  const boardWrap=document.getElementById('boardWrap');
  const boardEl=document.getElementById('board');
  const scoreEl=document.getElementById('score');
  const timeEl=document.getElementById('time');
  const startBtn=document.getElementById('startBtn');
  const resultOverlay=document.getElementById('resultOverlay');
  const resultText=document.getElementById('resultText');
  const resultBtns=document.getElementById('resultBtns');
  const restartBtn=document.getElementById('restartBtn');

  const muchiAudio = document.getElementById('muchiAudio');
  const smashAudio=document.getElementById('smashAudio');
  const noAudio=document.getElementById('noAudio');
  const bgmAudio=document.getElementById('bgmAudio');
  const congAudio=document.getElementById('congAudio');
  const feverAudio=document.getElementById('feverAudio');

  const pauseOverlay=document.getElementById('pauseOverlay');
  const resumeBtn=document.getElementById('resumeBtn');
  const pauseBtn=document.getElementById('pauseBtn');
  const muteBtn=document.getElementById('muteBtn');

  const rankingBtn = document.getElementById('rankingBtn');
  const rankingOverlay = document.getElementById('rankingOverlay');
  const closeRanking = document.getElementById('closeRanking');
  const lbRestartBtn = document.getElementById('lbRestart');
  const rankingList = document.getElementById('rankingList');
  const lbEmpty = document.getElementById('lbEmpty');

  const IMG_CC='CC.png';
  const IMG_NN='NN.png';

  let score=0, combo=0, timeLeft=60;
  let timerId=null, spawnTimeout=null;
  let running=false, paused=false;
  let muted=false;

  // NEWãƒ©ãƒ™ãƒ«ç”¨ã®ç›´è¿‘ç™»éŒ²TS
  let lastNewTs = null;

  // ===== å›ºå®šãƒ†ãƒ³ãƒ =====
  const SHOW_MS  = 1050; // å‡ºã¦ã„ã‚‹æ™‚é–“ï¼ˆä¸€å®šï¼‰
  const SPAWN_MS = 900;  // å‡ºç¾é–“éš”ï¼ˆä¸€å®šï¼‰
  const BATCH_MIN = 3;   // åŒæ™‚å‡ºç¾ã®æœ€å°
  const BATCH_MAX = 4;   // åŒæ™‚å‡ºç¾ã®æœ€å¤§
  const NN_P     = 0.20; // NNç‡

  // ===== ç›¤é¢ç”Ÿæˆ =====
  function buildBoard(){
    boardEl.innerHTML='';
    for(let i=0;i<COLS*ROWS;i++){
      const hole=document.createElement('div'); hole.className='hole';
      const img=document.createElement('img'); img.className='target'; img.alt='target'; img.draggable=false; img.decoding='async';
      img.addEventListener('pointerdown', onHit, {passive:true});
      hole.appendChild(img);
      const fl=document.createElement('div'); fl.className='float'; hole.appendChild(fl);
      boardEl.appendChild(hole);
    }
  }

  function setScore(v){ score=v; scoreEl.textContent=v; }
  function setCombo(v){ combo=v; }
  function updateStartButton(){ startBtn.textContent = !running ? 'ã‚¹ã‚¿ãƒ¼ãƒˆ' : (paused ? 'å†é–‹' : 'ä¸€æ™‚åœæ­¢'); }

  function startGame(){
    running=true; paused=false; setScore(0); setCombo(0); timeLeft=60; timeEl.textContent=timeLeft;
    hideResult(); hideRanking();
    boardEl.classList.remove('fever'); boardWrap.classList.remove('fever'); // FEVERè§£é™¤
    [smashAudio, noAudio, bgmAudio, congAudio, muchiAudio, feverAudio].forEach(a=>{ try{ a.load(); }catch(e){} });
    [smashAudio,noAudio,bgmAudio,congAudio,muchiAudio,feverAudio].forEach(a=> a.muted = muted);
    try{ bgmAudio.currentTime=0; bgmAudio.play().catch(()=>{}); }catch(e){}
    runTimer(); scheduleNextSpawn(SPAWN_MS); updateStartButton();
  }
  function toggleStartPause(){ if(!running){ startGame(); } else if(!paused){ pauseGame(); } else { resumeGame(); } }

  function pauseGame(){
    if(!running||paused) return; paused=true; updateStartButton();
    clearInterval(timerId); clearTimeout(spawnTimeout);
    try{ bgmAudio.pause(); }catch(e){}
    document.querySelectorAll('.target').forEach(img=>{ if(img._hideTid){ clearTimeout(img._hideTid); img._hideTid=null; } });
    pauseOverlay.style.display='flex';
  }
  function resumeGame(){
    if(!running||!paused) return; paused=false; updateStartButton();
    try{ bgmAudio.play().catch(()=>{}); }catch(e){}
    runTimer(); scheduleNextSpawn(0);
    document.querySelectorAll('.target.up').forEach(img=>{
      if(!img._hideTid){ img._hideTid=setTimeout(()=>{ instantHide(img); }, 600); }
    });
    pauseOverlay.style.display='none';
  }

  function runTimer(){
    clearInterval(timerId);
    timerId=setInterval(()=>{
      timeLeft--; timeEl.textContent=timeLeft;
      if(timeLeft<=0){ clearInterval(timerId); timeLeft=0; timeEl.textContent=0; endGame(); }
    },1000);
  }

  // ===== å‡ºç¾ï¼ˆä¸€å®šãƒšãƒ¼ã‚¹ãƒ»ä½•åº¦ã§ã‚‚åŒã˜ç©´OKï¼‰ =====
  const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

  function scheduleNextSpawn(delay){ clearTimeout(spawnTimeout); spawnTimeout = setTimeout(spawnTick, delay); }
  function spawnTick(){
    if(!running || paused){ scheduleNextSpawn(200); return; }

    const holes=[...document.querySelectorAll('.hole')];
    const targets = holes.map(h=>h.querySelector('.target'));
    const available = targets.filter(img=>!img.classList.contains('up'));

    const want = randInt(BATCH_MIN, BATCH_MAX);
    const n = Math.min(want, available.length);

    for (let i=0;i<n;i++){
      const idx = randInt(0, available.length-1);
      const img = available.splice(idx,1)[0];

      img.style.removeProperty('transform');
      const isNN=Math.random()<NN_P;
      img.src=isNN?IMG_NN:IMG_CC;
      img.dataset.kind=isNN?'nn':'cc';
      img.classList.add('up');
      img.classList.remove('hit');
      img.style.pointerEvents='auto';
      img._hideTid=setTimeout(()=>{ instantHide(img); }, SHOW_MS);
    }

    scheduleNextSpawn(SPAWN_MS);
  }

  // å³é€€é¿ï¼ˆæ¬¡å›ã‚¹ãƒãƒ¼ãƒ³ã®å¦¨ã’ã‚’æ®‹ã•ãªã„ï¼‰
  function instantHide(img){
    img.classList.remove('up');
    img.style.pointerEvents='none';
    img.style.transition='none';
    img.style.removeProperty('transform');
    img.offsetHeight; // reflow
    img.style.transition='';
    img._hideTid=null;
  }

  function onHit(e){
    if(!running || paused) return;
    const img = e.currentTarget;
    if(!img.classList.contains('up') || img.classList.contains('hit')) return;

    img.classList.add('hit');
    if(img._hideTid){ clearTimeout(img._hideTid); img._hideTid = null; }
    instantHide(img);

    const hole = img.parentElement;
    const fl   = hole.querySelector('.float');

    if (img.dataset.kind === 'cc') {
      const prevCombo = combo;        // 9â†’10åˆ°é”æ¤œçŸ¥
      setCombo(combo + 1);
      const add = Math.min(combo, 10);
      setScore(score + add);

      // 9â†’10ã«ãªã£ãŸç¬é–“ï¼šfever.mp3 å†ç”Ÿï¼‹ç›¤é¢FEVER ONï¼ˆå¤–æ ã‚‚ï¼‰
      if(prevCombo < 10 && combo >= 10){
        playAudio(feverAudio);
        boardEl.classList.add('fever');
        boardWrap.classList.add('fever');
      }

      // 10ã‚³ãƒ³ãƒœä»¥ä¸Šã¯ muchiã€ãã‚Œæœªæº€ã¯ smash
      const sfx = (combo >= 10) ? muchiAudio : smashAudio;
      playAudio(sfx);

      // è¡¨ç¤ºï¼š10ã‚³ãƒ³ãƒœä»¥ä¸Šã¯é»„è‰²ï¼†1.4å€
      const opts = (combo >= 10) ? { color: '#ffd400', scale: 1.4 } : {};
      floatText(fl, `+${add}`, opts);
    } else {
      // ãƒŸã‚¹ï¼šã‚³ãƒ³ãƒœåˆ‡ã‚Œï¼†-10ç‚¹ï¼ˆèµ¤1.4å€ï¼‰ã€FEVERè§£é™¤ï¼ˆå¤–æ ã‚‚ï¼‰
      setCombo(0);
      setScore(score - 10);
      playAudio(noAudio);
      floatText(fl, `-10`, { color: '#ff3b30', scale: 1.4 });
      boardEl.classList.remove('fever');
      boardWrap.classList.remove('fever');
    }
  }

  function playAudio(a){ try{ a.currentTime=0; a.muted = muted; a.play().catch(()=>{}); }catch(e){} }
  function floatText(el, text, opts = {}) {
    const scale = opts.scale || 1;
    el.textContent = text;
    el.style.color = opts.color || '';
    el.style.transition = 'none';
    el.style.opacity = '0';
    el.style.transform = `translate(-50%, 8px) scale(${0.96 * scale})`;
    requestAnimationFrame(() => {
      el.style.transition = 'transform .18s ease, opacity .18s ease';
      el.style.opacity = '1';
      el.style.transform = `translate(-50%, -16px) scale(${1 * scale})`;
      setTimeout(() => { el.style.opacity = '0'; }, 180);
    });
  }

  // ===== ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆTOP5ï¼šæ—¥ä»˜ï¼‹ç‚¹æ•°ã®ã¿ã€è‡ªå‹•ç™»éŒ²ï¼‰ =====
  const TOP_LIMIT = 5;
  const KEY_LB   = 'whack_local_lb_v2'; // v2ï¼ˆåå‰ãªã—ç‰ˆï¼‰

  function getLB(){ try { return JSON.parse(localStorage.getItem(KEY_LB) || '[]'); } catch { return []; } }
  function saveLB(list){ localStorage.setItem(KEY_LB, JSON.stringify(list)); }
  function insertScoreAuto(scoreVal){
    const d = new Date();
    const dateStr = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
    const entry = { score: Number(scoreVal)||0, date: dateStr, ts: d.toISOString() };
    const lb = getLB();
    lb.push(entry);
    lb.sort((a,b)=> b.score - a.score || new Date(a.ts) - new Date(b.ts)); // é«˜å¾—ç‚¹å„ªå…ˆãƒ»åŒç‚¹ã¯å¤ã„æ–¹
    const cut = lb.slice(0, TOP_LIMIT);
    saveLB(cut);
    return entry.ts; // ç›´è¿‘ç™»éŒ²ã®è­˜åˆ¥ã«ä½¿ã†
  }
  function renderLB(){
    const lb = getLB();
    rankingList.innerHTML = '';
    if(lb.length === 0){ lbEmpty.style.display='block'; return; }
    lbEmpty.style.display='none';
    lb.forEach((r,i)=>{
      const li = document.createElement('li');
      const isNew = (lastNewTs && r.ts === lastNewTs);
      li.innerHTML = `
        <span class="lb-rank">${i+1}</span>
        <span class="lb-name">${r.date}</span>
        <span class="lb-score">${isNew?'<span class="lb-new">NEW</span>':''}${Number(r.score).toLocaleString()}</span>
      `;
      rankingList.appendChild(li);
    });
  }
  function isTopLocal(sc){
    const lb = getLB();
    if(lb.length < TOP_LIMIT) return sc > 0;
    return Number(sc) >= Number(lb[lb.length-1]?.score ?? -Infinity);
  }

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘
  function showRanking(){ renderLB(); rankingOverlay.style.display='flex'; }
  function hideRanking(){ rankingOverlay.style.display='none'; lastNewTs = null; }

  // TOP5ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ãƒãƒŠãƒ¼
  function showTopBanner(){
    const content = document.querySelector('#rankingOverlay .ranking-content');
    const old = content.querySelector('.top5-banner'); if(old) old.remove();
    const banner = document.createElement('div');
    banner.className = 'top5-banner';
    banner.textContent = 'TOP5ã«ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ï¼';
    banner.style.cssText = 'text-align:center;margin:6px 0 10px;font-weight:900;color:#ffde59;';
    content.insertBefore(banner, content.children[1]); // ã‚¿ã‚¤ãƒˆãƒ«ç›´ä¸‹
    setTimeout(()=> banner.remove(), 2500);
  }

  // ===== çµæœ â†’ è‡ªå‹•ç™»éŒ² or é€šå¸¸çµæœ =====
  function endGame(){
    running=false; paused=false; updateStartButton(); clearTimeout(spawnTimeout);
    try{ bgmAudio.pause(); }catch(e){}
    document.querySelectorAll('.target').forEach(t=> instantHide(t));
    try{ congAudio.currentTime=0; congAudio.muted = muted; congAudio.play().catch(()=>{}); }catch(e){}
    boardEl.classList.remove('fever'); boardWrap.classList.remove('fever'); // FEVERè§£é™¤

    const qualifies = isTopLocal(score);

    if(qualifies){
      lastNewTs = insertScoreAuto(score); // â˜… è‡ªå‹•ç™»éŒ²ã—ã¦TSã‚’ä¿æŒ
      showRanking();                      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é–‹ãï¼ˆNEWè¡¨ç¤ºã‚ã‚Šï¼‰
      showTopBanner();                    // ãƒãƒŠãƒ¼è¡¨ç¤º
    }else{
      resultText.textContent = `ã‚¹ã‚³ã‚¢ ${score}ç‚¹`;
      resultBtns.innerHTML = `<button id="restartBtn">ã‚‚ã†ä¸€åº¦</button>
                              <button id="seeLBBtn" style="background:#7b61ff;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>`;
      document.getElementById('restartBtn').onclick=()=>{ startGame(); hideResult(); };
      document.getElementById('seeLBBtn').onclick=()=>{ hideResult(); showRanking(); };
      resultOverlay.style.display='flex';
    }
  }

  function hideResult(){ resultOverlay.style.display='none'; }

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆï¼†åˆæœŸåŒ– =====
  document.getElementById('startBtn').addEventListener('click', toggleStartPause);
  restartBtn.addEventListener('click', ()=>{ startGame(); }); // åˆæœŸã ã‘ã®ãƒ€ãƒŸãƒ¼

  // ãƒŸãƒ¥ãƒ¼ãƒˆ
  muteBtn.addEventListener('click', ()=>{
    muted = !muted;
    [smashAudio,noAudio,bgmAudio,congAudio,muchiAudio,feverAudio].forEach(a=> a.muted = muted);
    muteBtn.textContent = muted ? 'ğŸ”ˆ' : 'ğŸ”‡';
  });

  // ä¸€æ™‚åœæ­¢
  pauseBtn.addEventListener('click', ()=>{ if(!running) return; if(!paused) pauseGame(); });
  resumeBtn.addEventListener('click', ()=>{ resumeGame(); });

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  rankingBtn.addEventListener('click', ()=> showRanking());
  closeRanking.addEventListener('click', ()=> hideRanking());
  lbRestartBtn.addEventListener('click', ()=>{ hideRanking(); startGame(); });

  // ç›¤é¢ç”Ÿæˆ
  buildBoard(); updateStartButton();
});
</script>
</body>
</html>
