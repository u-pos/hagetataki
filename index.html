<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>1分ランキング（サウンド付き・4x4・オフライン）</title>
  <style>
    :root { --cols:4; --rows:4; --hole:21vw; --gap:2.5vw; --radius:2vw; }
    html,body { margin:0; height:100%; background:#0e0e10; color:#fff; font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif; overflow:hidden; overscroll-behavior:none; touch-action:none; }
    .wrap { height:100dvh; width:100vw; display:flex; flex-direction:column; align-items:center; box-sizing:border-box; padding:8px 10px; gap:8px; }

    .header { width:100%; display:flex; gap:2vw; align-items:center; justify-content:space-between; }
    .stats { display:flex; gap:2vw; align-items:center; }
    .badge { background:#1b1b1f; border:1px solid #2a2a33; padding:.9vw 1.6vw; border-radius:999px; font-size:3.6vw; min-width:16vw; text-align:center; }

    .controls { display:flex; gap:2vw; align-items:center; }
    button { border:none; border-radius:3vw; padding:1.2vw 2.2vw; background:#2b2b33; color:#fff; font-weight:700; font-size:3.6vw; }
    button:active { transform:translateY(1px); }
    #startBtn { background:#2563eb; color:#fff; padding:1.4vw 3.2vw; min-width:28vw; } /* 青ボタン */

    .main { flex:1; display:flex; justify-content:center; align-items:center; }
    .board { width:calc(var(--cols)*var(--hole)+(var(--cols)-1)*var(--gap)); height:calc(var(--rows)*var(--hole)+(var(--rows)-1)*var(--gap)); display:grid; grid-template-columns:repeat(var(--cols),var(--hole)); grid-template-rows:repeat(var(--rows),var(--hole)); gap:var(--gap); }
    .hole { position:relative; background: radial-gradient(ellipse at center,#15151a 0%,#0f0f12 70%,#07070a 100%); border-radius:calc(var(--radius)+4px); overflow:hidden; }
    .target { position:absolute; inset:auto 0 0 0; margin:auto; width:88%; aspect-ratio:1/1; transform:translateY(110%); transition: transform .2s cubic-bezier(.2,.7,.2,1), filter .1s ease; border-radius:12px; pointer-events:auto; }
    .target.up { transform:translateY(0); }
    .target.hit { filter:brightness(.85) grayscale(.2); }
    .float { position:absolute; left:50%; top:30%; transform:translateX(-50%); font-weight:900; font-size:4.2vw; text-shadow:0 2px 6px rgba(0,0,0,.6); opacity:0; pointer-events:none; }

    .footer { width:100%; display:flex; justify-content:space-between; align-items:center; font-size:3.2vw; }

    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000; padding:12px; }
    .modal { background:#121219; border:1px solid #2a2a33; border-radius:16px; padding:18px; max-width:560px; width:94vw; }
    .celebrate { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1100; pointer-events:none; }

    @media (min-width: 721px) {
      :root { --hole:120px; --gap:12px; --radius:14px; }
      .badge, button { font-size:14px; }
      #startBtn { min-width:140px; }
      .float { font-size:18px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <header class="header">
    <div class="stats">
      <div class="badge">Score <span id="score">0</span></div>
      <div class="badge">Time <span id="time">60</span>s</div>
    </div>
    <div class="controls">
      <button id="startBtn">スタート</button>
    </div>
  </header>

  <main class="main">
    <div class="board" id="board"></div>
  </main>

  <footer class="footer">クラウンを叩けば加算、セノバイトを叩くと減点。コンボを続けて大量得点GET！</footer>
</div>

<!-- サウンド -->
<audio id="smashAudio" src="smash.mp3" preload="auto"></audio>
<audio id="noAudio" src="no.mp3" preload="auto"></audio>
<audio id="bgmAudio" src="BGM.mp3" preload="auto" loop></audio>
<audio id="congAudio" src="cong.mp3" preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ===== スクロール/ジェスチャー抑止 =====
  const stop = (e)=>{ e.preventDefault(); };
  document.addEventListener('touchmove', stop, {passive:false});
  document.addEventListener('gesturestart', stop);
  window.addEventListener('scroll', ()=> window.scrollTo(0,0));

  // ===== 定数 =====
  const COLS=4, ROWS=4;
  const boardEl=document.getElementById('board');
  const scoreEl=document.getElementById('score');
  const timeEl=document.getElementById('time');
  const startBtn=document.getElementById('startBtn');

  const smashAudio=document.getElementById('smashAudio');
  const noAudio=document.getElementById('noAudio');
  const bgmAudio=document.getElementById('bgmAudio');
  const congAudio=document.getElementById('congAudio');

  const IMG_CC='CC.png';
  const IMG_NN='NN.png';

  let score=0, combo=0, timeLeft=60;
  let timerId=null, spawnTimeout=null;
  let running=false, paused=false;

  // ==== 出現テンポ（一定のまま）====
  const SHOW_MS    = 1050; // 出ている時間（一定）
  const SPAWN_MS   = 900;  // 出現間隔（一定）
  const DOUBLE_PROB= 0.18; // たまに2体出る
  const NN_PROB    = 0.20; // NNの確率

  // ===== 盤面作成 =====
  function buildBoard(){
    boardEl.innerHTML='';
    for(let i=0;i<COLS*ROWS;i++){
      const hole=document.createElement('div'); hole.className='hole';
      const img=document.createElement('img'); img.className='target'; img.alt='target'; img.draggable=false; img.decoding='async';
      img.addEventListener('pointerdown', onHit, {passive:true});
      hole.appendChild(img);
      const fl=document.createElement('div'); fl.className='float'; hole.appendChild(fl);
      boardEl.appendChild(hole);
    }
  }

  function setScore(v){ score=v; scoreEl.textContent=v; }
  function setCombo(v){ combo=v; }

  function updateStartButton(){
    startBtn.textContent = !running ? 'スタート' : (paused ? '再開' : '一時停止');
  }

  function startGame(){
    running=true; paused=false; setScore(0); setCombo(0); timeLeft=60; timeEl.textContent=timeLeft;
    [smashAudio,noAudio,bgmAudio,congAudio].forEach(a=>{ try{ a.load(); }catch(e){} });
    try{ bgmAudio.currentTime=0; bgmAudio.play().catch(()=>{}); }catch(e){}
    runTimer(); scheduleNextSpawn(SPAWN_MS); updateStartButton();
  }
  function toggleStartPause(){ if(!running){ startGame(); } else if(!paused){ pauseGame(); } else { resumeGame(); } }

  function pauseGame(){
    if(!running||paused) return; paused=true; updateStartButton();
    clearInterval(timerId); clearTimeout(spawnTimeout);
    try{ bgmAudio.pause(); }catch(e){}
    document.querySelectorAll('.target').forEach(img=>{ if(img._hideTid){ clearTimeout(img._hideTid); img._hideTid=null; } });
  }
  function resumeGame(){
    if(!running||!paused) return; paused=false; updateStartButton();
    try{ bgmAudio.play().catch(()=>{}); }catch(e){}
    runTimer(); scheduleNextSpawn(0);
    document.querySelectorAll('.target.up').forEach(img=>{
      if(!img._hideTid){ img._hideTid=setTimeout(()=>{ instantHide(img); }, 600); }
    });
  }

  function runTimer(){
    clearInterval(timerId);
    timerId=setInterval(()=>{
      timeLeft--; timeEl.textContent=timeLeft;
      if(timeLeft<=0){ clearInterval(timerId); timeLeft=0; timeEl.textContent=0; endGame(); }
    },1000);
  }

  // ===== 出現（一定ペース） =====
  function scheduleNextSpawn(delay){ clearTimeout(spawnTimeout); spawnTimeout = setTimeout(spawnTick, delay); }
  function spawnTick(){
    if(!running || paused){ scheduleNextSpawn(200); return; }
    const holes=[...document.querySelectorAll('.hole')];
    const count=Math.random()<DOUBLE_PROB?2:1;
    for(let k=0;k<count;k++){
      const hole=holes[Math.floor(Math.random()*holes.length)];
      const img=hole.querySelector('.target'); if(img.classList.contains('up')) continue;
      const isNN=Math.random()<NN_PROB; img.src=isNN?IMG_NN:IMG_CC; img.dataset.kind=isNN?'nn':'cc';
      img.classList.add('up'); img.classList.remove('hit'); img.style.pointerEvents='auto';
      img._hideTid=setTimeout(()=>{ instantHide(img); }, SHOW_MS);
    }
    scheduleNextSpawn(SPAWN_MS); // ← 変えない（一定のまま）
  }

  // 叩いたら“必ず”即時に引っ込む
  function instantHide(img){
    img.classList.remove('up');
    img.style.pointerEvents='none';
    const prev = img.style.transition;
    img.style.transition = 'none';
    img.style.transform  = 'translateY(110%)';
    img.offsetHeight; // reflow
    img.style.transition = prev;
    img._hideTid = null;
  }

  function onHit(e){
    if(!running || paused) return;
    const img=e.currentTarget;
    if(!img.classList.contains('up')||img.classList.contains('hit')) return;

    img.classList.add('hit');
    if(img._hideTid){ clearTimeout(img._hideTid); img._hideTid=null; }
    instantHide(img); // 即退避

    const hole=img.parentElement; const fl=hole.querySelector('.float');
    if(img.dataset.kind==='cc'){
      setCombo(combo+1);
      setScore(score+combo);
      playAudio(smashAudio);
      floatText(fl, `+${combo}`);
    }else{
      setCombo(0);
      setScore(score-50);
      playAudio(noAudio);
      floatText(fl, `-50`);
    }
  }

  function playAudio(a){ try{ a.currentTime=0; a.play().catch(()=>{}); }catch(e){} }
  function floatText(el, text){
    el.textContent=text;
    el.style.transition='none'; el.style.opacity='0'; el.style.transform='translate(-50%, 8px) scale(0.96)';
    requestAnimationFrame(()=>{
      el.style.transition='transform .18s ease, opacity .18s ease';
      el.style.opacity='1'; el.style.transform='translate(-50%, -16px) scale(1)';
      setTimeout(()=>{ el.style.opacity='0'; }, 180);
    });
  }

  function endGame(){
    running=false; paused=false; updateStartButton(); clearTimeout(spawnTimeout);
    try{ bgmAudio.pause(); }catch(e){}
    document.querySelectorAll('.target').forEach(t=> instantHide(t));
    // ここでは単に効果音だけ（ランキング等は完全排除）
    try{ congAudio.currentTime=0; congAudio.play().catch(()=>{}); }catch(e){}
    // 必要なら alert に切替可
    // alert(`タイムアップ！スコア: ${score}`);
  }

  // ===== イベント =====
  startBtn.addEventListener('click', toggleStartPause);

  // ===== 初期化 =====
  buildBoard(); updateStartButton();
});
</script>
</body>
</html>
