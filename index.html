<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Whack-a-CC ‚Äî 1ÂàÜ„É©„É≥„Ç≠„É≥„Ç∞Ôºà„Çπ„É©„Ç§„ÉâÁ¶ÅÊ≠¢„Éª„ÉØ„É≥ÁîªÈù¢Ôºâ</title>
  <style>
    :root { --cols:3; --rows:3; --hole:26vw; --gap:3vw; --radius:2.2vw; }
    html,body { margin:0; height:100%; background:#0e0e10; color:#fff; font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif; }
    /* ÁîªÈù¢„Çπ„É©„Ç§„Éâ/„É™„Éï„É¨„ÉÉ„Ç∑„É•/„Ç∫„Éº„É†„ÇíÊäëÊ≠¢ */
    html, body { overflow:hidden; overscroll-behavior:none; touch-action:none; }

    .wrap { height:100dvh; width:100vw; display:flex; flex-direction:column; align-items:center; box-sizing:border-box; padding:8px 10px; gap:8px; }

    .header { width:100%; display:flex; gap:2vw; align-items:center; justify-content:space-between; }
    .brand { font-weight:800; letter-spacing:0.5px; font-size:4.4vw; opacity:.9; }
    .stats { display:flex; gap:2vw; align-items:center; }
    .badge { background:#1b1b1f; border:1px solid #2a2a33; padding:.9vw 1.6vw; border-radius:999px; font-size:3.6vw; min-width:16vw; text-align:center; }
    .score { font-weight:800; }
    .time { font-variant-numeric:tabular-nums; font-weight:700; }
    .combo { background:#26223a; border:1px solid #3b2f6d; }

    .controls { display:flex; gap:2vw; }
    button { appearance:none; border:none; border-radius:3vw; padding:1.8vw 2.6vw; background:#2b2b33; color:#fff; font-weight:700; letter-spacing:.3px; box-shadow:0 1px 0 rgba(255,255,255,.06) inset, 0 10px 20px rgba(0,0,0,.2); cursor:pointer; font-size:3.6vw; }
    button:active { transform:translateY(1px); }
    button:disabled { opacity:.45; cursor:not-allowed; }

    .main { flex:1; width:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; }

    .board { position:relative; width:calc(var(--cols) * var(--hole) + (var(--cols) - 1) * var(--gap)); height:calc(var(--rows) * var(--hole) + (var(--rows) - 1) * var(--gap)); display:grid; grid-template-columns: repeat(var(--cols), var(--hole)); grid-template-rows: repeat(var(--rows), var(--hole)); gap:var(--gap); user-select:none; -webkit-user-drag:none; }
    .hole { position:relative; background: radial-gradient(ellipse at center, #15151a 0%, #0f0f12 70%, #07070a 100%); border-radius: calc(var(--radius) + 4px); box-shadow:inset 0 8px 22px rgba(0,0,0,.55), inset 0 -10px 20px rgba(255,255,255,.05); overflow:hidden; }
    .target { position:absolute; inset:auto 0 0 0; margin:auto; width:88%; aspect-ratio:1 / 1; transform: translateY(110%); transition: transform .18s cubic-bezier(.2,.7,.2,1), filter .1s ease; will-change: transform, filter; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.55); pointer-events:auto; }
    .target.up { transform: translateY(0%); }
    .target.hit { filter:brightness(.8) grayscale(.2); }
    .float { position:absolute; left:50%; top:30%; transform:translateX(-50%); font-weight:900; font-size:5vw; text-shadow:0 2px 6px rgba(0,0,0,.6); opacity:0; pointer-events:none; }

    .footer { width:100%; display:flex; justify-content:space-between; align-items:center; gap:2vw; }
    .note { opacity:.8; font-size:3.2vw; }

    /* „É©„É≥„Ç≠„É≥„Ç∞„ÅØ„É¢„Éº„ÉÄ„É´„Åß„ÉØ„É≥ÁîªÈù¢ÂÜÖ„Å´Âèé„ÇÅ„Çã */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:12px; z-index:1000; }
    .modal { width:min(560px, 94vw); max-height:86dvh; background:#121219; border:1px solid #2a2a33; border-radius:16px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.5); display:flex; flex-direction:column; gap:10px; }
    .modal h2 { margin:0; font-size:5vw; }
    .modal p { margin:0; font-size:3.6vw; opacity:.9; }
    .modal .row { display:flex; gap:8px; }
    .modal input { flex:1; background:#1b1b22; border:1px solid #2b2b33; border-radius:10px; color:#fff; padding:10px 12px; font-size:16px; }
    .lb-wrap { overflow:auto; border-radius:12px; }
    table { width:100%; border-collapse:separate; border-spacing:0 8px; }
    th { text-align:left; font-size:12px; opacity:.6; font-weight:700; }
    td { background:#17171e; border:1px solid #2a2a31; padding:10px 12px; border-radius:10px; font-variant-numeric: tabular-nums; }
    .lb-rank { width:56px; text-align:center; font-weight:800; }
    .lb-name { max-width:38vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .lb-score { text-align:right; font-weight:900; }

    .celebrate { position:fixed; inset:0; display:none; align-items:center; justify-content:center; pointer-events:none; z-index:1100; }
    .celebrate .msg { background:rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.15); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); padding:14px 18px; border-radius:16px; font-size:20px; font-weight:900; box-shadow:0 10px 40px rgba(0,0,0,.5); }
    .confetti { position:absolute; top:-10vh; width:8px; height:14px; border-radius:2px; opacity:.95; animation: fall linear forwards; }
    @keyframes fall { to { transform: translateY(115vh) rotate(720deg); opacity:.95; } }

    @media (min-width: 721px) {
      :root { --hole:160px; --gap:14px; --radius:14px; }
      .brand { font-size:18px; }
      .badge, .note, button { font-size:14px; }
      .float { font-size:20px; }
    }
  </style>
</head>
<body>
<div class="wrap" id="appRoot">
  <header class="header">
    <div class="brand">Whack-a-CC / 1MIN</div>
    <div class="stats">
      <div class="badge">Score <span id="score" class="score">0</span></div>
      <div class="badge">Time <span id="time" class="time">60</span>s</div>
      <div class="badge combo">Combo <span id="combo">0</span></div>
    </div>
    <div class="controls">
      <button id="startBtn">„Çπ„Çø„Éº„Éà</button>
      <button id="lbBtn">„É©„É≥„Ç≠„É≥„Ç∞</button>
      <button id="resetLB" title="„É≠„Éº„Ç´„É´„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞„ÇíÂàùÊúüÂåñ">LB„É™„Çª„ÉÉ„Éà</button>
    </div>
  </header>

  <main class="main">
    <div class="board" id="board" aria-label="„É¢„Ç∞„É©„Åü„Åü„ÅçÁõ§"></div>
  </main>

  <footer class="footer">
    <div class="note">CC.png: Âä†ÁÇπ(„Ç≥„É≥„ÉúÂ¢ó) Ôºè NN.png: -50ÁÇπÔºÜ„Ç≥„É≥„Éú0</div>
  </footer>
</div>

<!-- „Çπ„Ç≥„Ç¢ÁôªÈå≤„É¢„Éº„ÉÄ„É´ -->
<div class="overlay" id="entryOverlay" role="dialog" aria-modal="true">
  <div class="modal" style="max-width:520px;">
    <h2>„Çπ„Ç≥„Ç¢ÁôªÈå≤</h2>
    <p>TOP15„Å´ÂÖ•„Å£„Åü„ÅßÔºÅÂêçÂâç„ÇíÂÖ•„Çå„Å¶ÁôªÈå≤„Åó„Çà„ÅãÔºü</p>
    <div class="row">
      <input id="nameInput" type="text" maxlength="16" placeholder="ÂêçÂâçÔºàÊú™ÂÖ•Âäõ„Å™„Çâ„ÄéÂêçÁÑ°„Åó„Åï„Çì„ÄèÔºâ" />
      <button id="saveScore">ÁôªÈå≤</button>
      <button id="skipScore">„Çπ„Ç≠„ÉÉ„Éó</button>
    </div>
  </div>
</div>

<!-- „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫„É¢„Éº„ÉÄ„É´ÔºàÁîªÈù¢ÂÜÖ„Çπ„ÇØ„É≠„Éº„É´„ÅÆ„ÅøÔºâ -->
<div class="overlay" id="lbOverlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h2 style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
      <span>TOP15 „É©„É≥„Ç≠„É≥„Ç∞</span>
      <button id="closeLB">Èñâ„Åò„Çã</button>
    </h2>
    <div class="lb-wrap">
      <table id="lbTable">
        <thead><tr><th>#</th><th>ÂêçÂâç</th><th>„Çπ„Ç≥„Ç¢</th><th>Êó•ÊôÇ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- „ÅäÁ•ù„ÅÑ -->
<div class="celebrate" id="celebrate"><div class="msg">üéâ „É©„É≥„ÇØ„Ç§„É≥ÔºÅ„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ</div></div>
<audio id="congAudio" src="cong.mp3" preload="auto"></audio>

<script>
(function(){
  // ===== „Çπ„ÇØ„É≠„Éº„É´/„Ç∫„Éº„É†Á¶ÅÊ≠¢ÔºàÂÖ•ÂäõÂøÖË¶ÅÁÆáÊâÄ„ÅØËß£Èô§Ôºâ =====
  const stop = (e)=>{ e.preventDefault(); };
  document.addEventListener('touchmove', stop, {passive:false});
  document.addEventListener('gesturestart', stop);
  window.addEventListener('scroll', ()=> window.scrollTo(0,0));

  const enableScrollIn = (el)=>{
    el.addEventListener('touchmove', (e)=>{ /* „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÅØË®±ÂèØ */ }, {passive:true});
  };

  const COLS=3, ROWS=3;
  const boardEl = document.getElementById('board');
  const scoreEl = document.getElementById('score');
  const timeEl = document.getElementById('time');
  const comboEl = document.getElementById('combo');
  const startBtn = document.getElementById('startBtn');
  const lbBtn = document.getElementById('lbBtn');
  const resetLB = document.getElementById('resetLB');
  const lbTableBody = document.querySelector('#lbTable tbody');
  const lbOverlay = document.getElementById('lbOverlay');
  const closeLB = document.getElementById('closeLB');
  const entryOverlay = document.getElementById('entryOverlay');
  const nameInput = document.getElementById('nameInput');
  const saveScoreBtn = document.getElementById('saveScore');
  const skipScoreBtn = document.getElementById('skipScore');
  const celebrate = document.getElementById('celebrate');
  const congAudio = document.getElementById('congAudio');

  const KEY_LB='wam_leaderboard_v2';
  const KEY_NAME='wam_last_name';
  const IMG_CC='CC.png';
  const IMG_NN='NN.png';

  let score=0, combo=0, timeLeft=60, timerId=null, running=false;
  let spawnTimer=null, speed=900, interval=700;

  function buildBoard(){
    boardEl.innerHTML='';
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
      const hole=document.createElement('div'); hole.className='hole';
      const img=document.createElement('img'); img.className='target'; img.alt='target'; img.draggable=false; img.decoding='async';
      img.addEventListener('pointerdown', onHit, {passive:true});
      hole.appendChild(img);
      const fl=document.createElement('div'); fl.className='float'; hole.appendChild(fl);
      boardEl.appendChild(hole);
    }
  }

  function setScore(v){ score=v; scoreEl.textContent=v; }
  function setCombo(v){ combo=v; comboEl.textContent=v; }

  function start(){
    if(running) return; running=true;
    setScore(0); setCombo(0); timeLeft=60; timeEl.textContent=timeLeft;
    startBtn.disabled=true;
    preload([IMG_CC, IMG_NN]);
    runTimer(); startSpawning();
  }

  function runTimer(){
    clearInterval(timerId);
    timerId=setInterval(()=>{ timeLeft--; timeEl.textContent=timeLeft; if(timeLeft<=0){ clearInterval(timerId); timeLeft=0; timeEl.textContent=0; endGame(); } },1000);
  }

  function startSpawning(){
    clearInterval(spawnTimer);
    spawnTimer=setInterval(function tick(){
      const holes=[...document.querySelectorAll('.hole')];
      const count=Math.random()<0.2?2:1;
      for(let k=0;k<count;k++){
        const hole=holes[Math.floor(Math.random()*holes.length)];
        const img=hole.querySelector('.target'); if(img.classList.contains('up')) continue;
        const isNN=Math.random()<0.2; img.src=isNN?IMG_NN:IMG_CC; img.dataset.kind=isNN?'nn':'cc';
        img.classList.add('up'); img.classList.remove('hit'); img.style.pointerEvents='auto';
        const showFor=Math.max(420, speed + (Math.random()*200-100));
        setTimeout(()=>{ img.classList.remove('up'); img.style.pointerEvents='none'; }, showFor);
      }
      if(interval>420) interval-=6; if(speed>520) speed-=4;
      clearInterval(spawnTimer); spawnTimer=setInterval(tick, interval);
    }, interval);
  }

  function onHit(e){
    if(!running) return; const img=e.currentTarget; if(!img.classList.contains('up')||img.classList.contains('hit')) return;
    img.classList.add('hit'); img.style.pointerEvents='none';
    const hole=img.parentElement; const fl=hole.querySelector('.float');
    if(img.dataset.kind==='cc'){ setCombo(combo+1); setScore(score+combo); floatText(fl, `+${combo}`); }
    else { setCombo(0); setScore(score-50); floatText(fl, `-50`); }
  }

  function floatText(el, text){
    el.textContent=text; el.style.transition='none'; el.style.opacity='0'; el.style.transform='translate(-50%, 10px)';
    requestAnimationFrame(()=>{ el.style.transition='transform .22s ease, opacity .22s ease'; el.style.opacity='1'; el.style.transform='translate(-50%, -18px)'; setTimeout(()=>{ el.style.opacity='0'; }, 220); });
  }

  function endGame(){
    running=false; startBtn.disabled=false; clearInterval(spawnTimer);
    document.querySelectorAll('.target').forEach(t=>{ t.classList.remove('up'); t.style.pointerEvents='none'; });
    const lb=getLB(); const qualifies= lb.length<15 || score > (lb[lb.length-1]?.score ?? -1);
    if(score!==0 && qualifies){ nameInput.value=localStorage.getItem(KEY_NAME)||''; entryOverlay.style.display='flex'; }
  }

  // ===== „É©„É≥„Ç≠„É≥„Ç∞Âá¶ÁêÜ =====
  function getLB(){ try{ return JSON.parse(localStorage.getItem(KEY_LB)||'[]'); }catch(e){ return []; } }
  function saveLB(list){ localStorage.setItem(KEY_LB, JSON.stringify(list)); }
  function insertScore(name,score){ const now=new Date(); const entry={name:(name||'').trim()||'ÂêçÁÑ°„Åó„Åï„Çì',score,ts:now.toISOString()}; const lb=getLB(); lb.push(entry); lb.sort((a,b)=>b.score-a.score); const cut=lb.slice(0,15); saveLB(cut); return cut.findIndex(x=>x===entry); }
  function renderLB(){ const lb=getLB(); lbTableBody.innerHTML=''; lb.forEach((r,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="lb-rank">${idx+1}</td><td class="lb-name">${esc(r.name)}</td><td class="lb-score">${r.score.toLocaleString()}</td><td style="opacity:.7; font-size:12px;">${fmtDate(r.ts)}</td>`; lbTableBody.appendChild(tr); }); }
  function fmtDate(iso){ try{ const d=new Date(iso); return `${d.getFullYear()}/${(d.getMonth()+1+'').padStart(2,'0')}/${(d.getDate()+'').padStart(2,'0')} ${(d.getHours()+'').padStart(2,'0')}:${(d.getMinutes()+'').padStart(2,'0')}` }catch(e){ return ''; } }
  function esc(s){ return (s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",
                                 ">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  saveScoreBtn.addEventListener('click', finalizeEntry);
  skipScoreBtn.addEventListener('click', ()=>{ entryOverlay.style.display='none'; showLeaderboard(); });
  lbBtn.addEventListener('click', ()=>{ showLeaderboard(); });
  resetLB.addEventListener('click', ()=>{ if(confirm('„É≠„Éº„Ç´„É´„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')){ localStorage.setItem(KEY_LB,'[]'); renderLB(); } });
  closeLB.addEventListener('click', ()=>{ lbOverlay.style.display='none'; });

  function finalizeEntry(){
    const name=nameInput.value.trim(); localStorage.setItem(KEY_NAME,name); entryOverlay.style.display='none'; const rank=insertScore(name,score); renderLB(); celebrateRank(rank);
  }

  function showLeaderboard(){ renderLB(); lbOverlay.style.display='flex'; }

  function celebrateRank(rank){ try{ congAudio.currentTime=0; congAudio.play().catch(()=>{}); }catch(e){} celebrate.style.display='flex'; spawnConfetti(); setTimeout(()=>{ celebrate.style.display='none'; celebrate.innerHTML='<div class="msg">üéâ „É©„É≥„ÇØ„Ç§„É≥ÔºÅ„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ</div>'; }, 2200); }
  function spawnConfetti(){ const colors=['#ff5f6d','#f9cb28','#36d1dc','#5b86e5','#a8ff78','#78ffd6','#c471f5','#fa71cd','#f6d365','#fda085','#f093fb','#f5576c']; const N=60; for(let i=0;i<N;i++){ const d=document.createElement('div'); d.className='confetti'; d.style.left=Math.random()*100+'vw'; d.style.background=colors[Math.floor(Math.random()*colors.length)]; d.style.animationDuration=(1.2+Math.random()*1.2)+'s'; d.style.transform=`translateY(0) rotate(${Math.random()*360}deg)`; celebrate.appendChild(d);} setTimeout(()=>{ document.querySelectorAll('.confetti').forEach(x=>x.remove()); },2400); }

  function preload(srcs){ srcs.forEach(s=>{ const i=new Image(); i.src=s; }); }

  // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆ„Åø„Çø„ÉÉ„ÉÅ„Çπ„ÇØ„É≠„Éº„É´„ÇíË®±ÂèØ
  enableScrollIn(document.querySelector('#lbOverlay .lb-wrap'));

  buildBoard(); renderLB();
  startBtn.addEventListener('click', start);
})();
</script>
</body>
</html>
